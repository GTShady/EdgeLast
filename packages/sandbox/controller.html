<title>Proxy Sandbox Controller</title>
<script>
	function wake(controller) {
		controller.postMessage({ $sandboxsw$type: "wake" });
	}
	navigator.serviceWorker
		.register("/sw.js", {
			scope: "./",
		})
		.then((registration) => {
			if (navigator.serviceWorker.controller) {
				// there's probably already a service worker
				wake(navigator.serviceWorker.controller);
			} else {
				// there's no service worker, wait until we're controlled
				navigator.serviceWorker.addEventListener("controllerchange", () => {
					wake(navigator.serviceWorker.controller);
				});
			}
		})
		.catch((error) => {
			console.error("Service Worker registration failed:", error);
			window.parent.postMessage(
				{ $sandboxsw$type: "initerror", message: error.message },
				"*"
			);
		});
	navigator.serviceWorker.addEventListener("message", (event) => {
		let data = event.data;
		if ("$sandboxsw$type" in data) {
			let transfer;
			if (data.$sandboxsw$message?.body) {
				let body = data.$sandboxsw$message.body;
				if (body instanceof ArrayBuffer || body instanceof ReadableStream) {
					transfer = [body];
				}
			}
			window.parent.postMessage(event.data, "*", transfer);
		}
	});
	window.addEventListener("message", (event) => {
		let data = event.data;
		if ("$sandboxsw$type" in data) {
			if (navigator.serviceWorker.controller) {
				let transfer;
				if (data.$sandboxsw$message?.body) {
					let body = data.$sandboxsw$message.body;
					if (body instanceof ArrayBuffer || body instanceof ReadableStream) {
						transfer = [body];
					}
				}
				navigator.serviceWorker.controller.postMessage(data, transfer);
			} else {
				console.error("No service worker controller to send message to.");
			}
		}
	});
</script>
